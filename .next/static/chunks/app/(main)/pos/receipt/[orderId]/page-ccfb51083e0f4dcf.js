(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[586],{2872:function(e,t,a){Promise.resolve().then(a.bind(a,8589))},5863:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9763).Z)("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},3388:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9763).Z)("Smartphone",[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]])},9376:function(e,t,a){"use strict";var r=a(5475);a.o(r,"useParams")&&a.d(t,{useParams:function(){return r.useParams}}),a.o(r,"usePathname")&&a.d(t,{usePathname:function(){return r.usePathname}}),a.o(r,"useRouter")&&a.d(t,{useRouter:function(){return r.useRouter}}),a.o(r,"useSearchParams")&&a.d(t,{useSearchParams:function(){return r.useSearchParams}})},8589:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return y}});var r=a(7437),s=a(2265),n=a(9376),i=a(5151),o=a(9820),d=a(2381),c=a(1593),l=a(5863),u=a(9763);let h=(0,u.Z)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);var m=a(3388);let p=(0,u.Z)("Printer",[["polyline",{points:"6 9 6 2 18 2 18 9",key:"1306q4"}],["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["rect",{width:"12",height:"8",x:"6",y:"14",key:"5ipwut"}]]);var f=a(4438),x=a(8086);function y(){var e,t;let a=(0,n.useRouter)(),u=(0,n.useParams)().orderId,[y,g]=(0,s.useState)(null),[v,N]=(0,s.useState)(!0),[j,I]=(0,s.useState)(null);if((0,s.useEffect)(()=>{u&&(async()=>{N(!0),I(null);try{let e=await i.u.getSalesOrderByIdWithItems(u);e.success&&e.data?g(e.data):(I(e.error||"Kh\xf4ng thể tải chi tiết đơn h\xe0ng."),f.Am.error(e.error||"Kh\xf4ng thể tải chi tiết đơn h\xe0ng."))}catch(e){I("Lỗi khi tải chi tiết đơn h\xe0ng: "+e.message),f.Am.error("Lỗi khi tải chi tiết đơn h\xe0ng: "+e.message)}finally{N(!1)}})()},[u]),v)return(0,r.jsxs)("div",{className:"flex justify-center items-center min-h-screen",children:[(0,r.jsx)(l.Z,{className:"h-12 w-12 animate-spin text-blue-500"}),(0,r.jsx)("p",{className:"ml-3 text-lg",children:"Đang tải h\xf3a đơn..."})]});if(j||!y)return(0,r.jsxs)("div",{className:"flex flex-col justify-center items-center min-h-screen text-center",children:[(0,r.jsx)("p",{className:"text-xl text-red-500 mb-4",children:j||"Kh\xf4ng t\xecm thấy th\xf4ng tin h\xf3a đơn."}),(0,r.jsxs)(d.z,{onClick:()=>a.push("/pos"),children:[(0,r.jsx)(h,{className:"w-4 h-4 mr-2"}),"Quay lại POS"]})]});let{order:b,items:S}=y;return(0,r.jsx)("div",{className:"max-w-2xl mx-auto p-4 sm:p-6 lg:p-8 bg-white",children:(0,r.jsxs)(o.Zb,{className:"shadow-lg",children:[(0,r.jsx)(o.Ol,{className:"bg-gray-50 p-6 rounded-t-lg",children:(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(o.ll,{className:"text-2xl font-bold text-gray-800",children:"H\xf3a Đơn B\xe1n H\xe0ng"}),(0,r.jsxs)("p",{className:"text-sm text-gray-500",children:["M\xe3 đơn h\xe0ng: ",b.orderNumber]})]}),(0,r.jsx)("div",{className:"w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center",children:(0,r.jsx)(m.Z,{className:"w-5 h-5 text-white"})})]})}),(0,r.jsxs)(o.aY,{className:"p-6 space-y-6",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-700 mb-1",children:"Th\xf4ng tin kh\xe1ch h\xe0ng:"}),(0,r.jsxs)("p",{children:["T\xean: ",(null===(e=b.customerInfo)||void 0===e?void 0:e.name)||"Kh\xe1ch lẻ"]}),(0,r.jsxs)("p",{children:["Điện thoại: ",(null===(t=b.customerInfo)||void 0===t?void 0:t.phone)||"N/A"]})]}),(0,r.jsxs)("div",{className:"text-right",children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-700 mb-1",children:"Ng\xe0y tạo h\xf3a đơn:"}),(0,r.jsx)("p",{children:(0,x.p6)(b.orderDate)}),(0,r.jsx)("h3",{className:"font-semibold text-gray-700 mt-2 mb-1",children:"Nh\xe2n vi\xean:"}),(0,r.jsx)("p",{children:b.staffName||b.staffId})]})]}),(0,r.jsx)(c.Z,{}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-700 mb-3 text-lg",children:"Chi tiết sản phẩm:"}),(0,r.jsx)("div",{className:"space-y-3",children:S.map(e=>(0,r.jsxs)("div",{className:"flex justify-between items-start p-3 bg-gray-50 rounded-md",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"font-medium text-gray-800",children:e.productName}),(0,r.jsxs)("p",{className:"text-xs text-gray-500",children:[e.storageCapacity," - ",e.colorName," (IMEI: ",e.imei,")"]})]}),(0,r.jsx)("p",{className:"font-semibold text-gray-800",children:(0,x.xG)(e.finalPrice)})]},e.id))})]}),(0,r.jsx)(c.Z,{}),(0,r.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Tạm t\xednh:"}),(0,r.jsx)("span",{className:"font-medium text-gray-800",children:(0,x.xG)(b.subtotalAmount)})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsxs)("span",{className:"text-gray-600",children:["Thuế VAT (",100*b.taxRate,"%):"]}),(0,r.jsx)("span",{className:"font-medium text-gray-800",children:(0,x.xG)(b.taxAmount)})]}),b.discountAmount>0&&(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Giảm gi\xe1:"}),(0,r.jsxs)("span",{className:"font-medium text-red-600",children:["-",(0,x.xG)(b.discountAmount)]})]}),b.shippingAmount>0&&(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Ph\xed vận chuyển:"}),(0,r.jsx)("span",{className:"font-medium text-gray-800",children:(0,x.xG)(b.shippingAmount)})]}),(0,r.jsx)(c.Z,{className:"my-2"}),(0,r.jsxs)("div",{className:"flex justify-between text-lg font-bold text-blue-600",children:[(0,r.jsx)("span",{children:"Tổng cộng:"}),(0,r.jsx)("span",{children:(0,x.xG)(b.totalAmount)})]})]}),(0,r.jsx)(c.Z,{}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-700 mb-2",children:"Th\xf4ng tin thanh to\xe1n:"}),(0,r.jsxs)("p",{className:"text-sm",children:["Phương thức: ","cash"===b.paymentMethod?"Tiền mặt":"card"===b.paymentMethod?"Thẻ ng\xe2n h\xe0ng":"Chuyển khoản"]}),"cash"===b.paymentMethod&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("p",{className:"text-sm",children:["Tiền kh\xe1ch đưa: ",(0,x.xG)(b.amountReceived||0)]}),(0,r.jsxs)("p",{className:"text-sm",children:["Tiền trả lại: ",(0,x.xG)(b.changeGiven||0)]})]})]}),(0,r.jsx)("p",{className:"text-xs text-center text-gray-500 pt-4",children:"Cảm ơn qu\xfd kh\xe1ch đ\xe3 mua h\xe0ng!"})]}),(0,r.jsxs)(o.eW,{className:"p-6 bg-gray-50 rounded-b-lg flex justify-end space-x-3",children:[(0,r.jsxs)(d.z,{variant:"outline",onClick:()=>a.push("/pos"),children:[(0,r.jsx)(h,{className:"w-4 h-4 mr-2"}),"Tạo đơn mới"]}),(0,r.jsxs)(d.z,{onClick:()=>{window.print()},children:[(0,r.jsx)(p,{className:"w-4 h-4 mr-2"}),"In h\xf3a đơn"]})]})]})})}},2381:function(e,t,a){"use strict";a.d(t,{d:function(){return d},z:function(){return c}});var r=a(7437),s=a(2265),n=a(7053),i=a(535),o=a(3448);let d=(0,i.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),c=s.forwardRef((e,t)=>{let{className:a,variant:s,size:i,asChild:c=!1,...l}=e,u=c?n.g7:"button";return(0,r.jsx)(u,{className:(0,o.cn)(d({variant:s,size:i,className:a})),ref:t,...l})});c.displayName="Button"},1593:function(e,t,a){"use strict";a.d(t,{Z:function(){return o}});var r=a(7437),s=a(2265),n=a(5156),i=a(3448);let o=s.forwardRef((e,t)=>{let{className:a,orientation:s="horizontal",decorative:o=!0,...d}=e;return(0,r.jsx)(n.f,{ref:t,decorative:o,orientation:s,className:(0,i.cn)("shrink-0 bg-border","horizontal"===s?"h-[1px] w-full":"h-full w-[1px]",a),...d})});o.displayName=n.f.displayName},5151:function(e,t,a){"use strict";a.d(t,{u:function(){return d}});var r=a(5978),s=a(6410),n=a(8086),i=a(3976);class o extends n.bQ{async getAvailableProductsForSale(){try{let e=(0,r.hJ)(s.db,i.Ul.INVENTORY),t=(0,r.IO)(e,(0,r.ar)("status","in",i.sM)),a=await (0,r.PL)(t);if(a.empty)return{success:!0,data:[]};let n=a.docs.map(e=>({id:e.id,...e.data()})),o=new Map;for(let e of n){if(!e.productId||!e.variantId){console.warn("Inventory item ".concat(e.id," missing productId or variantId, skipping."));continue}let t=o.get(e.productId);t||(t={productId:e.productId,productName:e.productName||"Unknown Product",variants:[]},o.set(e.productId,t));let a=t.variants.find(t=>t.variantId===e.variantId);a||(a={variantId:e.variantId,variantSku:e.variantSku||"Unknown SKU",colorName:e.colorName||"Unknown Color",storageCapacity:e.storageCapacity||"Unknown Storage",availableImeis:[],totalStock:0},t.variants.push(a)),a.availableImeis.push({inventoryItemId:e.id,imei:e.imei,currentRetailPrice:e.currentRetailPrice,entryDate:e.entryDate}),a.totalStock+=1}return{success:!0,data:Array.from(o.values())}}catch(e){return this.handleError(e)}}async createSaleOrder(e,t,a){try{var o,d;let c;let l=e.customerId;if(!l&&(null===(o=e.customerInfo)||void 0===o?void 0:o.phone)&&(null===(d=e.customerInfo)||void 0===d?void 0:d.name)){let t=(0,r.hJ)(s.db,i.Ul.CUSTOMERS),a=(0,r.IO)(t,(0,r.ar)("phone","==",e.customerInfo.phone),(0,r.b9)(1)),n=await (0,r.PL)(a);l=n.empty?(c=(0,r.JU)(t)).id:n.docs[0].id}return await this.runTransaction(async o=>{var d;let u;let h=r.EK.now(),m=(0,r.JU)((0,r.hJ)(s.db,i.Ul.SALES_ORDERS)),p=(0,n.m1)("SO"),f=e.items.map(e=>(0,r.JU)(s.db,i.Ul.INVENTORY,e.inventoryItemId)),x=await Promise.all(f.map(e=>o.get(e)));if(l&&!c){let e=(0,r.JU)(s.db,i.Ul.CUSTOMERS,l);if(!(u=await o.get(e)).exists())throw Error("Kh\xe1ch h\xe0ng với ID ".concat(l," kh\xf4ng t\xecm thấy."))}let y=0,g=[],v=[],N=[];for(let a=0;a<x.length;a++){let r=x[a],s=e.items[a];if(!r.exists())throw Error("Sản phẩm với IMEI ".concat(s.imei," kh\xf4ng t\xecm thấy trong kho."));let n={id:r.id,...r.data()};if(n.imei!==s.imei)throw Error("IMEI kh\xf4ng khớp cho sản phẩm ".concat(s.inventoryItemId,"."));if(n.status!==i.eM.IN_STOCK)throw Error("Sản phẩm ".concat(n.productName," (").concat(s.imei,") kh\xf4ng c\xf2n sẵn."));let o=n.currentRetailPrice;y+=o,g.push({id:"temp-id",salesOrderId:m.id,inventoryItemId:n.id,imei:n.imei,productId:n.productId,variantId:n.variantId,productName:n.productName,variantSku:n.variantSku,colorName:n.colorName,storageCapacity:n.storageCapacity,quantity:1,unitCost:n.entryPrice,salePrice:o,itemDiscountAmount:0,itemTaxAmount:0,finalPrice:o,itemStatus:"fulfilled",entryDateOfItem:n.entryDate,createdAt:h,updatedAt:h,createdBy:t,updatedBy:t}),v.push({ref:f[a],data:{status:i.eM.SOLD,lastStatusChange:h,salesOrderId:m.id,saleDate:h,actualSalePrice:o,warrantyStartDate:h}}),N.push({inventoryItemId:n.id,imei:n.imei,movementType:i.$D.SALE,timestamp:h,quantityChange:-1,previousStatus:i.eM.IN_STOCK,newStatus:i.eM.SOLD,fromLocation:n.currentLocation,toLocation:"Sold",userId:t,userRole:"pos_staff",reason:"B\xe1n h\xe0ng qua POS - Đơn ".concat(p),relatedOrderId:m.id,relatedDocumentType:"sale",createdAt:h,updatedAt:h,createdBy:t,updatedBy:t})}if(c&&(null===(d=e.customerInfo)||void 0===d?void 0:d.name)){let a={name:e.customerInfo.name,phone:e.customerInfo.phone,email:e.customerInfo.email||"",address:{street:e.customerInfo.address||"",city:"TP.HCM",type:"home"},acquisitionChannel:"walk_in"},s={...a,dateOfBirth:r.EK.now(),addresses:a.address?[{id:"default",street:a.address.street,city:a.address.city,country:"Vietnam",isDefault:!0,type:"home"}]:[],totalOrders:0,totalSpent:0,averageOrderValue:0,customerTier:"new",loyaltyPoints:0,lifetimeValue:0,preferredContactMethod:"phone",communicationPreferences:{promotions:!0,newProducts:!0,appointments:!0,orderUpdates:!0,warrantyReminders:!0},isVip:!1,isCorporate:!1,allowMarketing:!0,requiresApproval:!1,isActive:!0,isBlacklisted:!1,createdAt:h,updatedAt:h,createdBy:t,updatedBy:t};o.set(c,s)}let j=e.taxRate||0,I=y*j,b=e.discountAmount||0,S=e.shippingAmount||0,w=y+I-b+S,k={orderNumber:p,orderDate:h,customerInfo:e.customerInfo,subtotalAmount:y,taxRate:j,taxAmount:I,discountAmount:b,shippingAmount:S,totalAmount:w,paymentMethod:e.paymentMethod,paymentStatus:"paid",status:"completed",salesChannel:e.salesChannel||"pos",staffId:t,staffName:a||"",amountReceived:"cash"===e.paymentMethod?e.amountReceived:void 0,changeGiven:"cash"===e.paymentMethod&&e.amountReceived?e.amountReceived-w:void 0,totalItems:e.items.length,totalQuantity:e.items.length,notes:e.notes,createdAt:h,updatedAt:h,createdBy:t,updatedBy:t};if(l&&(k.customerId=l),o.set(m,k),l){let e=(0,r.JU)(s.db,i.Ul.CUSTOMERS,l),t=u?u.data():{totalOrders:0,totalSpent:0,firstPurchaseDate:h},a=(t.totalOrders||0)+1,n=(t.totalSpent||0)+w,d={totalOrders:a,totalSpent:n,averageOrderValue:n/a,lastPurchaseDate:h,firstPurchaseDate:t.firstPurchaseDate||h};o.update(e,d)}for(let e=0;e<g.length;e++){let{id:t,...a}=g[e],n=(0,r.JU)((0,r.hJ)(s.db,m.path,i.N9.ORDER_ITEMS));o.set(n,a),g[e].id=n.id}return v.forEach(e=>o.update(e.ref,e.data)),N.forEach(e=>{let t=(0,r.JU)((0,r.hJ)(s.db,i.Ul.STOCK_MOVEMENTS));o.set(t,e)}),{...k,id:m.id,items:g}})}catch(e){return console.error("Create sale order error:",e),this.handleError(e)}}async getSalesOrderByIdWithItems(e){try{let t=(0,r.JU)(s.db,i.Ul.SALES_ORDERS,e),a=await (0,r.QT)(t);if(!a.exists())return{success:!1,error:"Kh\xf4ng t\xecm thấy đơn h\xe0ng với ID: ".concat(e),errorCode:"ORDER_NOT_FOUND"};let n={id:a.id,...a.data()},o=(0,r.hJ)(s.db,i.Ul.SALES_ORDERS,e,i.N9.ORDER_ITEMS),d=(await (0,r.PL)((0,r.IO)(o,(0,r.Xo)("createdAt","asc")))).docs.map(e=>({id:e.id,...e.data()}));return{success:!0,data:{order:n,items:d}}}catch(t){return console.error("Error fetching order ".concat(e," with items:"),t),this.handleError(t)}}async getSalesOrdersByCustomerId(e){try{let t=(0,r.hJ)(s.db,i.Ul.SALES_ORDERS),a=(0,r.IO)(t,(0,r.ar)("customerId","==",e),(0,r.Xo)("orderDate","desc")),n=(await (0,r.PL)(a)).docs.map(e=>({id:e.id,...e.data()}));return{success:!0,data:n}}catch(e){return this.handleError(e)}}constructor(){super(i.Ul.SALES_ORDERS)}}let d=new o},5156:function(e,t,a){"use strict";a.d(t,{f:function(){return c}});var r=a(2265),s=a(6840),n=a(7437),i="horizontal",o=["horizontal","vertical"],d=r.forwardRef((e,t)=>{let{decorative:a,orientation:r=i,...d}=e,c=o.includes(r)?r:i;return(0,n.jsx)(s.WV.div,{"data-orientation":c,...a?{role:"none"}:{"aria-orientation":"vertical"===c?c:void 0,role:"separator"},...d,ref:t})});d.displayName="Separator";var c=d}},function(e){e.O(0,[358,139,933,825,438,252,971,117,744],function(){return e(e.s=2872)}),_N_E=e.O()}]);