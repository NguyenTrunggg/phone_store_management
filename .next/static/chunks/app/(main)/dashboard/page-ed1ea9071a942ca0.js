(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[248],{2504:function(e,t,a){Promise.resolve().then(a.bind(a,3207))},3639:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9763).Z)("AlertTriangle",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z",key:"c3ski4"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},5252:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9763).Z)("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]])},6275:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9763).Z)("ShoppingCart",[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]])},3388:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9763).Z)("Smartphone",[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]])},525:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9763).Z)("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]])},5805:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9763).Z)("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]])},3207:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return F}});var r=a(7437),s=a(2265),n=a(9820),i=a(9174),c=a(3966),o=a(6840),l="Progress",[d,u]=(0,c.b)(l),[h,m]=d(l),p=s.forwardRef((e,t)=>{var a,s,n,i;let{__scopeProgress:c,value:l=null,max:d,getValueLabel:u=g,...m}=e;(d||0===d)&&!j(d)&&console.error((a="".concat(d),s="Progress","Invalid prop `max` of value `".concat(a,"` supplied to `").concat(s,"`. Only numbers greater than 0 are valid max values. Defaulting to `").concat(100,"`.")));let p=j(d)?d:100;null===l||N(l,p)||console.error((n="".concat(l),i="Progress","Invalid prop `value` of value `".concat(n,"` supplied to `").concat(i,"`. The `value` prop must be:\n  - a positive number\n  - less than the value passed to `max` (or ").concat(100," if no `max` prop is set)\n  - `null` or `undefined` if the progress is indeterminate.\n\nDefaulting to `null`.")));let x=N(l,p)?l:null,f=y(x)?u(x,p):void 0;return(0,r.jsx)(h,{scope:c,value:x,max:p,children:(0,r.jsx)(o.WV.div,{"aria-valuemax":p,"aria-valuemin":0,"aria-valuenow":y(x)?x:void 0,"aria-valuetext":f,role:"progressbar","data-state":v(x,p),"data-value":null!=x?x:void 0,"data-max":p,...m,ref:t})})});p.displayName=l;var x="ProgressIndicator",f=s.forwardRef((e,t)=>{var a;let{__scopeProgress:s,...n}=e,i=m(x,s);return(0,r.jsx)(o.WV.div,{"data-state":v(i.value,i.max),"data-value":null!==(a=i.value)&&void 0!==a?a:void 0,"data-max":i.max,...n,ref:t})});function g(e,t){return"".concat(Math.round(e/t*100),"%")}function v(e,t){return null==e?"indeterminate":e===t?"complete":"loading"}function y(e){return"number"==typeof e}function j(e){return y(e)&&!isNaN(e)&&e>0}function N(e,t){return y(e)&&!isNaN(e)&&e<=t&&e>=0}f.displayName=x;var w=a(3448);let b=s.forwardRef((e,t)=>{let{className:a,value:s,...n}=e;return(0,r.jsx)(p,{ref:t,className:(0,w.cn)("relative h-4 w-full overflow-hidden rounded-full bg-secondary",a),...n,children:(0,r.jsx)(f,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:"translateX(-".concat(100-(s||0),"%)")}})})});b.displayName=p.displayName;var S=a(5252),I=a(6275),D=a(525),O=a(5805),E=a(3639),C=a(3388),k=a(5978),M=a(6410),R=a(8086),P=a(5151),A=a(3976);class U extends R.bQ{async getStatsForDateRange(e,t){let a=(0,k.hJ)(M.db,A.Ul.SALES_ORDERS),r=(0,k.IO)(a,(0,k.ar)("orderDate",">=",k.EK.fromDate(e)),(0,k.ar)("orderDate","<=",k.EK.fromDate(t))),s=await (0,k.PL)(r),n=0,i=new Set;return s.docs.forEach(e=>{var t;let a=e.data();n+=a.totalAmount,a.customerId?i.add(a.customerId):(null===(t=a.customerInfo)||void 0===t?void 0:t.phone)&&i.add(a.customerInfo.phone)}),{revenue:n,orders:s.size,customers:i}}calculatePercentageChange(e,t){return 0===t?e>0?100:0:(e-t)/t*100}async getDashboardStats(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:25e8;try{let a=new Date,r=new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0),s=new Date(a.getFullYear(),a.getMonth(),a.getDate(),23,59,59),n=new Date(a);n.setDate(a.getDate()-1);let i=new Date(n.getFullYear(),n.getMonth(),n.getDate(),0,0,0),c=new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,59),o=new Date(a.getFullYear(),a.getMonth(),1),l=new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59),[d,u]=await Promise.all([this.getStatsForDateRange(r,s),this.getStatsForDateRange(i,c)]),h=d.orders>0?d.revenue/d.orders:0,m=u.orders>0?u.revenue/u.orders:0,p={revenue:d.revenue,orders:d.orders,avgOrderValue:h,customers:d.customers.size,revenueChange:this.calculatePercentageChange(d.revenue,u.revenue),ordersChange:this.calculatePercentageChange(d.orders,u.orders),avgOrderValueChange:this.calculatePercentageChange(h,m),customersChange:this.calculatePercentageChange(d.customers.size,u.customers.size)},x=await P.u.getAvailableProductsForSale();if(!x.success||!x.data)throw Error("Could not fetch available products for inventory alerts.");let f=[];x.data.forEach(t=>{t.variants.forEach(a=>{a.totalStock<=e&&f.push({model:t.productName,variant:"".concat(a.storageCapacity," ").concat(a.colorName),stock:a.totalStock,status:0===a.totalStock?"out":"low"})})});let g=(0,k.B$)(M.db,A.N9.ORDER_ITEMS),v=(0,k.IO)(g,(0,k.ar)("createdAt",">=",k.EK.fromDate(r)),(0,k.ar)("createdAt","<=",k.EK.fromDate(s))),y=await (0,k.PL)(v),j=new Map;y.docs.forEach(e=>{let t=e.data();if(!t||!t.variantId||!t.productName){console.warn("Skipping malformed order item from Firestore:",e.id);return}let a=t.variantId,r="".concat(t.productName," ").concat(t.storageCapacity||"");j.has(a)||j.set(a,{name:r,sold:0,revenue:0});let s=j.get(a);s.sold+=t.quantity||0,s.revenue+=t.finalPrice||0});let N=Array.from(j.values()).sort((e,t)=>t.revenue-e.revenue).slice(0,5),w=await this.getStatsForDateRange(o,l),b={current:w.revenue,target:t,progress:t>0?w.revenue/t*100:0};return{success:!0,data:{todayStats:p,inventoryAlerts:f,topProducts:N,monthlyRevenue:b}}}catch(e){return this.handleError(e)}}constructor(){super("dashboard")}}let Z=new U;function _(e){let{className:t,...a}=e;return(0,r.jsx)("div",{className:(0,w.cn)("animate-pulse rounded-md bg-muted",t),...a})}function T(e){let{title:t,value:a,change:s,icon:i,formatAsCurrency:c=!1}=e,o=s>=0;return(0,r.jsxs)(n.Zb,{children:[(0,r.jsxs)(n.Ol,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,r.jsx)(n.ll,{className:"text-sm font-medium",children:t}),(0,r.jsx)(i,{className:"h-4 w-4 text-muted-foreground"})]}),(0,r.jsxs)(n.aY,{children:[(0,r.jsx)("div",{className:"text-2xl font-bold",children:c?"".concat(a.toLocaleString("vi-VN"),"₫"):a}),(0,r.jsxs)("p",{className:"text-xs text-muted-foreground",children:[(0,r.jsxs)("span",{className:o?"text-green-600":"text-red-600",children:[o?"+":"",s.toFixed(1),"%"]})," ","so với h\xf4m qua"]})]})]})}function L(){return(0,r.jsxs)(n.Zb,{children:[(0,r.jsxs)(n.Ol,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,r.jsx)(_,{className:"h-4 w-36"}),(0,r.jsx)(_,{className:"h-4 w-4"})]}),(0,r.jsxs)(n.aY,{children:[(0,r.jsx)(_,{className:"h-8 w-48 mb-2"}),(0,r.jsx)(_,{className:"h-3 w-32"})]})]})}function V(){return(0,r.jsxs)("div",{className:"space-y-6 animate-pulse",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(_,{className:"h-8 w-48 mb-2"}),(0,r.jsx)(_,{className:"h-4 w-72"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[(0,r.jsx)(L,{}),(0,r.jsx)(L,{}),(0,r.jsx)(L,{}),(0,r.jsx)(L,{})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,r.jsxs)(n.Zb,{children:[(0,r.jsxs)(n.Ol,{children:[(0,r.jsx)(_,{className:"h-6 w-40 mb-2"}),(0,r.jsx)(_,{className:"h-4 w-64"})]}),(0,r.jsx)(n.aY,{className:"space-y-4",children:[void 0,void 0,void 0].map((e,t)=>(0,r.jsxs)("div",{className:"flex items-center justify-between p-3 rounded-lg",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-3 w-full",children:[(0,r.jsx)(_,{className:"h-10 w-10 rounded-md"}),(0,r.jsxs)("div",{className:"w-full space-y-2",children:[(0,r.jsx)(_,{className:"h-4 w-3/4"}),(0,r.jsx)(_,{className:"h-3 w-1/2"})]})]}),(0,r.jsx)(_,{className:"h-6 w-16"})]},t))})]}),(0,r.jsxs)(n.Zb,{children:[(0,r.jsxs)(n.Ol,{children:[(0,r.jsx)(_,{className:"h-6 w-48 mb-2"}),(0,r.jsx)(_,{className:"h-4 w-80"})]}),(0,r.jsx)(n.aY,{className:"space-y-4",children:[void 0,void 0,void 0,void 0].map((e,t)=>(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-3 w-full",children:[(0,r.jsx)(_,{className:"w-8 h-8 rounded-lg"}),(0,r.jsxs)("div",{className:"w-full space-y-2",children:[(0,r.jsx)(_,{className:"h-4 w-3/5"}),(0,r.jsx)(_,{className:"h-3 w-2/5"})]})]}),(0,r.jsx)(_,{className:"h-5 w-24"})]},t))})]})]}),(0,r.jsxs)(n.Zb,{children:[(0,r.jsxs)(n.Ol,{children:[(0,r.jsx)(_,{className:"h-6 w-64 mb-2"}),(0,r.jsx)(_,{className:"h-4 w-96"})]}),(0,r.jsxs)(n.aY,{children:[(0,r.jsx)(_,{className:"h-4 w-full rounded-full"}),(0,r.jsxs)("div",{className:"flex justify-between mt-2",children:[(0,r.jsx)(_,{className:"h-4 w-24"}),(0,r.jsx)(_,{className:"h-4 w-32"})]})]})]})]})}function F(){let[e,t]=(0,s.useState)(null),[a,c]=(0,s.useState)(!0),[o,l]=(0,s.useState)(null);if((0,s.useEffect)(()=>{(async()=>{c(!0);let e=await Z.getDashboardStats();e.success&&e.data?t(e.data):l(e.error||"Failed to fetch dashboard data."),c(!1)})()},[]),a)return(0,r.jsx)(V,{});if(o||!e)return(0,r.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,r.jsx)("p",{className:"text-red-500",children:o||"Could not load dashboard data."})});let{todayStats:d,inventoryAlerts:u,topProducts:h,monthlyRevenue:m}=e;return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:"Dashboard"}),(0,r.jsx)("p",{className:"text-gray-600",children:"Tổng quan hoạt động kinh doanh h\xf4m nay"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[(0,r.jsx)(T,{title:"Doanh thu h\xf4m nay",value:d.revenue,change:d.revenueChange,icon:S.Z,formatAsCurrency:!0}),(0,r.jsx)(T,{title:"Đơn h\xe0ng",value:d.orders,change:d.ordersChange,icon:I.Z}),(0,r.jsx)(T,{title:"Gi\xe1 trị đơn h\xe0ng TB",value:d.avgOrderValue,change:d.avgOrderValueChange,icon:D.Z,formatAsCurrency:!0}),(0,r.jsx)(T,{title:"Kh\xe1ch h\xe0ng",value:d.customers,change:d.customersChange,icon:O.Z})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,r.jsxs)(n.Zb,{children:[(0,r.jsxs)(n.Ol,{children:[(0,r.jsxs)(n.ll,{className:"flex items-center",children:[(0,r.jsx)(E.Z,{className:"w-5 h-5 mr-2 text-orange-500"}),"Cảnh b\xe1o tồn kho"]}),(0,r.jsx)(n.SZ,{children:"C\xe1c sản phẩm sắp hết hoặc đ\xe3 hết h\xe0ng (ngưỡng: 5)"})]}),(0,r.jsx)(n.aY,{className:"space-y-4",children:u.length>0?u.map((e,t)=>(0,r.jsxs)("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,r.jsx)(C.Z,{className:"w-4 h-4 text-gray-500"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"font-medium text-sm",children:e.model}),(0,r.jsx)("p",{className:"text-xs text-gray-500",children:e.variant})]})]}),(0,r.jsx)("div",{className:"text-right",children:(0,r.jsx)(i.C,{variant:"out"===e.status?"destructive":"secondary",children:0===e.stock?"Hết h\xe0ng":"C\xf2n ".concat(e.stock)})})]},t)):(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"Kh\xf4ng c\xf3 cảnh b\xe1o tồn kho."})})]}),(0,r.jsxs)(n.Zb,{children:[(0,r.jsxs)(n.Ol,{children:[(0,r.jsx)(n.ll,{children:"Sản phẩm b\xe1n chạy"}),(0,r.jsx)(n.SZ,{children:"Top sản phẩm c\xf3 doanh thu cao nhất h\xf4m nay"})]}),(0,r.jsx)(n.aY,{className:"space-y-4",children:h.length>0?h.map((e,t)=>(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,r.jsx)("div",{className:"w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center",children:(0,r.jsx)("span",{className:"text-sm font-medium text-blue-600",children:t+1})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"font-medium text-sm",children:e.name}),(0,r.jsxs)("p",{className:"text-xs text-gray-500",children:["Đ\xe3 b\xe1n: ",e.sold," chiếc"]})]})]}),(0,r.jsx)("div",{className:"text-right",children:(0,r.jsxs)("p",{className:"font-medium text-sm",children:[e.revenue.toLocaleString("vi-VN"),"₫"]})})]},t)):(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"Chưa c\xf3 sản phẩm n\xe0o được b\xe1n h\xf4m nay."})})]})]}),(0,r.jsxs)(n.Zb,{children:[(0,r.jsxs)(n.Ol,{children:[(0,r.jsx)(n.ll,{children:"Tiến độ doanh thu th\xe1ng n\xe0y"}),(0,r.jsxs)(n.SZ,{children:["Mục ti\xeau: ",m.target.toLocaleString("vi-VN"),"₫ | Hiện tại:"," ",m.current.toLocaleString("vi-VN"),"₫"]})]}),(0,r.jsxs)(n.aY,{children:[(0,r.jsx)(b,{value:m.progress,className:"w-full"}),(0,r.jsxs)("div",{className:"flex justify-between text-sm text-gray-500 mt-2",children:[(0,r.jsxs)("span",{children:[m.progress.toFixed(1),"% ho\xe0n th\xe0nh"]}),(0,r.jsxs)("span",{children:["C\xf2n ",(m.target-m.current).toLocaleString("vi-VN"),"₫"]})]})]})]})]})}},9174:function(e,t,a){"use strict";a.d(t,{C:function(){return c}});var r=a(7437);a(2265);var s=a(535),n=a(3448);let i=(0,s.j)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function c(e){let{className:t,variant:a,...s}=e;return(0,r.jsx)("div",{className:(0,n.cn)(i({variant:a}),t),...s})}},5151:function(e,t,a){"use strict";a.d(t,{u:function(){return o}});var r=a(5978),s=a(6410),n=a(8086),i=a(3976);class c extends n.bQ{async getAvailableProductsForSale(){try{let e=(0,r.hJ)(s.db,i.Ul.INVENTORY),t=(0,r.IO)(e,(0,r.ar)("status","in",i.sM)),a=await (0,r.PL)(t);if(a.empty)return{success:!0,data:[]};let n=a.docs.map(e=>({id:e.id,...e.data()})),c=new Map;for(let e of n){if(!e.productId||!e.variantId){console.warn("Inventory item ".concat(e.id," missing productId or variantId, skipping."));continue}let t=c.get(e.productId);t||(t={productId:e.productId,productName:e.productName||"Unknown Product",variants:[]},c.set(e.productId,t));let a=t.variants.find(t=>t.variantId===e.variantId);a||(a={variantId:e.variantId,variantSku:e.variantSku||"Unknown SKU",colorName:e.colorName||"Unknown Color",storageCapacity:e.storageCapacity||"Unknown Storage",availableImeis:[],totalStock:0},t.variants.push(a)),a.availableImeis.push({inventoryItemId:e.id,imei:e.imei,currentRetailPrice:e.currentRetailPrice,entryDate:e.entryDate}),a.totalStock+=1}return{success:!0,data:Array.from(c.values())}}catch(e){return this.handleError(e)}}async createSaleOrder(e,t,a){try{var c,o;let l;let d=e.customerId;if(!d&&(null===(c=e.customerInfo)||void 0===c?void 0:c.phone)&&(null===(o=e.customerInfo)||void 0===o?void 0:o.name)){let t=(0,r.hJ)(s.db,i.Ul.CUSTOMERS),a=(0,r.IO)(t,(0,r.ar)("phone","==",e.customerInfo.phone),(0,r.b9)(1)),n=await (0,r.PL)(a);d=n.empty?(l=(0,r.JU)(t)).id:n.docs[0].id}return await this.runTransaction(async c=>{var o;let u;let h=r.EK.now(),m=(0,r.JU)((0,r.hJ)(s.db,i.Ul.SALES_ORDERS)),p=(0,n.m1)("SO"),x=e.items.map(e=>(0,r.JU)(s.db,i.Ul.INVENTORY,e.inventoryItemId)),f=await Promise.all(x.map(e=>c.get(e)));if(d&&!l){let e=(0,r.JU)(s.db,i.Ul.CUSTOMERS,d);if(!(u=await c.get(e)).exists())throw Error("Kh\xe1ch h\xe0ng với ID ".concat(d," kh\xf4ng t\xecm thấy."))}let g=0,v=[],y=[],j=[];for(let a=0;a<f.length;a++){let r=f[a],s=e.items[a];if(!r.exists())throw Error("Sản phẩm với IMEI ".concat(s.imei," kh\xf4ng t\xecm thấy trong kho."));let n={id:r.id,...r.data()};if(n.imei!==s.imei)throw Error("IMEI kh\xf4ng khớp cho sản phẩm ".concat(s.inventoryItemId,"."));if(n.status!==i.eM.IN_STOCK)throw Error("Sản phẩm ".concat(n.productName," (").concat(s.imei,") kh\xf4ng c\xf2n sẵn."));let c=n.currentRetailPrice;g+=c,v.push({id:"temp-id",salesOrderId:m.id,inventoryItemId:n.id,imei:n.imei,productId:n.productId,variantId:n.variantId,productName:n.productName,variantSku:n.variantSku,colorName:n.colorName,storageCapacity:n.storageCapacity,quantity:1,unitCost:n.entryPrice,salePrice:c,itemDiscountAmount:0,itemTaxAmount:0,finalPrice:c,itemStatus:"fulfilled",entryDateOfItem:n.entryDate,createdAt:h,updatedAt:h,createdBy:t,updatedBy:t}),y.push({ref:x[a],data:{status:i.eM.SOLD,lastStatusChange:h,salesOrderId:m.id,saleDate:h,actualSalePrice:c,warrantyStartDate:h}}),j.push({inventoryItemId:n.id,imei:n.imei,movementType:i.$D.SALE,timestamp:h,quantityChange:-1,previousStatus:i.eM.IN_STOCK,newStatus:i.eM.SOLD,fromLocation:n.currentLocation,toLocation:"Sold",userId:t,userRole:"pos_staff",reason:"B\xe1n h\xe0ng qua POS - Đơn ".concat(p),relatedOrderId:m.id,relatedDocumentType:"sale",createdAt:h,updatedAt:h,createdBy:t,updatedBy:t})}if(l&&(null===(o=e.customerInfo)||void 0===o?void 0:o.name)){let a={name:e.customerInfo.name,phone:e.customerInfo.phone,email:e.customerInfo.email||"",address:{street:e.customerInfo.address||"",city:"TP.HCM",type:"home"},acquisitionChannel:"walk_in"},s={...a,dateOfBirth:r.EK.now(),addresses:a.address?[{id:"default",street:a.address.street,city:a.address.city,country:"Vietnam",isDefault:!0,type:"home"}]:[],totalOrders:0,totalSpent:0,averageOrderValue:0,customerTier:"new",loyaltyPoints:0,lifetimeValue:0,preferredContactMethod:"phone",communicationPreferences:{promotions:!0,newProducts:!0,appointments:!0,orderUpdates:!0,warrantyReminders:!0},isVip:!1,isCorporate:!1,allowMarketing:!0,requiresApproval:!1,isActive:!0,isBlacklisted:!1,createdAt:h,updatedAt:h,createdBy:t,updatedBy:t};c.set(l,s)}let N=e.taxRate||0,w=g*N,b=e.discountAmount||0,S=e.shippingAmount||0,I=g+w-b+S,D={orderNumber:p,orderDate:h,customerInfo:e.customerInfo,subtotalAmount:g,taxRate:N,taxAmount:w,discountAmount:b,shippingAmount:S,totalAmount:I,paymentMethod:e.paymentMethod,paymentStatus:"paid",status:"completed",salesChannel:e.salesChannel||"pos",staffId:t,staffName:a||"",amountReceived:"cash"===e.paymentMethod?e.amountReceived:void 0,changeGiven:"cash"===e.paymentMethod&&e.amountReceived?e.amountReceived-I:void 0,totalItems:e.items.length,totalQuantity:e.items.length,notes:e.notes,createdAt:h,updatedAt:h,createdBy:t,updatedBy:t};if(d&&(D.customerId=d),c.set(m,D),d){let e=(0,r.JU)(s.db,i.Ul.CUSTOMERS,d),t=u?u.data():{totalOrders:0,totalSpent:0,firstPurchaseDate:h},a=(t.totalOrders||0)+1,n=(t.totalSpent||0)+I,o={totalOrders:a,totalSpent:n,averageOrderValue:n/a,lastPurchaseDate:h,firstPurchaseDate:t.firstPurchaseDate||h};c.update(e,o)}for(let e=0;e<v.length;e++){let{id:t,...a}=v[e],n=(0,r.JU)((0,r.hJ)(s.db,m.path,i.N9.ORDER_ITEMS));c.set(n,a),v[e].id=n.id}return y.forEach(e=>c.update(e.ref,e.data)),j.forEach(e=>{let t=(0,r.JU)((0,r.hJ)(s.db,i.Ul.STOCK_MOVEMENTS));c.set(t,e)}),{...D,id:m.id,items:v}})}catch(e){return console.error("Create sale order error:",e),this.handleError(e)}}async getSalesOrderByIdWithItems(e){try{let t=(0,r.JU)(s.db,i.Ul.SALES_ORDERS,e),a=await (0,r.QT)(t);if(!a.exists())return{success:!1,error:"Kh\xf4ng t\xecm thấy đơn h\xe0ng với ID: ".concat(e),errorCode:"ORDER_NOT_FOUND"};let n={id:a.id,...a.data()},c=(0,r.hJ)(s.db,i.Ul.SALES_ORDERS,e,i.N9.ORDER_ITEMS),o=(await (0,r.PL)((0,r.IO)(c,(0,r.Xo)("createdAt","asc")))).docs.map(e=>({id:e.id,...e.data()}));return{success:!0,data:{order:n,items:o}}}catch(t){return console.error("Error fetching order ".concat(e," with items:"),t),this.handleError(t)}}async getSalesOrdersByCustomerId(e){try{let t=(0,r.hJ)(s.db,i.Ul.SALES_ORDERS),a=(0,r.IO)(t,(0,r.ar)("customerId","==",e),(0,r.Xo)("orderDate","desc")),n=(await (0,r.PL)(a)).docs.map(e=>({id:e.id,...e.data()}));return{success:!0,data:n}}catch(e){return this.handleError(e)}}constructor(){super(i.Ul.SALES_ORDERS)}}let o=new c},3966:function(e,t,a){"use strict";a.d(t,{b:function(){return i},k:function(){return n}});var r=a(2265),s=a(7437);function n(e,t){let a=r.createContext(t),n=e=>{let{children:t,...n}=e,i=r.useMemo(()=>n,Object.values(n));return(0,s.jsx)(a.Provider,{value:i,children:t})};return n.displayName=e+"Provider",[n,function(s){let n=r.useContext(a);if(n)return n;if(void 0!==t)return t;throw Error(`\`${s}\` must be used within \`${e}\``)}]}function i(e,t=[]){let a=[],n=()=>{let t=a.map(e=>r.createContext(e));return function(a){let s=a?.[e]||t;return r.useMemo(()=>({[`__scope${e}`]:{...a,[e]:s}}),[a,s])}};return n.scopeName=e,[function(t,n){let i=r.createContext(n),c=a.length;a=[...a,n];let o=t=>{let{scope:a,children:n,...o}=t,l=a?.[e]?.[c]||i,d=r.useMemo(()=>o,Object.values(o));return(0,s.jsx)(l.Provider,{value:d,children:n})};return o.displayName=t+"Provider",[o,function(a,s){let o=s?.[e]?.[c]||i,l=r.useContext(o);if(l)return l;if(void 0!==n)return n;throw Error(`\`${a}\` must be used within \`${t}\``)}]},function(...e){let t=e[0];if(1===e.length)return t;let a=()=>{let a=e.map(e=>({useScope:e(),scopeName:e.scopeName}));return function(e){let s=a.reduce((t,{useScope:a,scopeName:r})=>{let s=a(e)[`__scope${r}`];return{...t,...s}},{});return r.useMemo(()=>({[`__scope${t.scopeName}`]:s}),[s])}};return a.scopeName=t.scopeName,a}(n,...t)]}}},function(e){e.O(0,[358,139,933,825,252,971,117,744],function(){return e(e.s=2504)}),_N_E=e.O()}]);