"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[362],{4362:function(e,r,s){s.d(r,{AuthProvider:function(){return c},aC:function(){return d}});var t=s(7437),a=s(2265),o=s(3301),n=s(5978),i=s(6410),l=s(5091);let u=(0,a.createContext)(void 0);function c(e){let{children:r}=e,[s,c]=(0,a.useState)(null),[d,p]=(0,a.useState)(null),[m,w]=(0,a.useState)(!1),[f,y]=(0,a.useState)(!0),v=(0,a.useCallback)((e,r)=>({uid:e.uid,email:e.email,displayName:r.displayName,role:r.role,isActive:r.isActive,permissions:r.permissions}),[]),h=(0,a.useCallback)(async e=>{try{let r=(0,n.JU)(i.db,"users",e);await (0,n.r7)(r,{lastLoginAt:n.EK.now(),totalLogins:((null==d?void 0:d.totalLogins)||0)+1,updatedAt:n.EK.now()})}catch(e){console.error("Failed to update last login:",e)}},[null==d?void 0:d.totalLogins]),g=(0,a.useCallback)(async e=>{w(!0);try{let r=(await (0,o.e5)(i.I8,e.email,e.password)).user,s=(0,n.JU)(i.db,"users",r.uid),t=await (0,n.QT)(s);if(!t.exists())throw Error("User profile not found. Please contact administrator.");let a=t.data();if(!a.isActive)throw await (0,o.w7)(i.I8),Error("Account is deactivated. Please contact administrator.");if(a.isDeleted)throw await (0,o.w7)(i.I8),Error("Account not found. Please contact administrator.");if(a.accountLockedUntil&&a.accountLockedUntil.toDate()>new Date){await (0,o.w7)(i.I8);let e=a.accountLockedUntil.toDate().toLocaleString();throw Error("Account is locked until ".concat(e,". Please contact administrator."))}await h(r.uid);let l=v(r,a);return c(l),p(a),l}catch(e){throw console.error("Login failed:",e),Error(e.message||"Login failed. Please try again.")}finally{w(!1)}},[v,h]),P=(0,a.useCallback)(async()=>{w(!0);try{await (0,o.w7)(i.I8),c(null),p(null)}catch(e){throw console.error("Logout failed:",e),Error("Logout failed. Please try again.")}finally{w(!1)}},[]),I=(0,a.useCallback)(async e=>{w(!0);try{var r,s;let t=(await (0,o.Xb)(i.I8,e.email,e.password)).user,a={id:t.uid,email:e.email,displayName:e.displayName,firstName:e.firstName,lastName:e.lastName,phone:e.phone,role:e.role,permissions:[],customPermissions:[],employeeId:e.employeeId,department:e.department,position:e.position,assignedStores:e.assignedStores||[],primaryStore:e.primaryStore,canAccessAllStores:"admin"===e.role,isActive:!0,isEmailVerified:!1,isPhoneVerified:!1,totalLogins:0,twoFactorEnabled:!1,preferences:{theme:"light",language:"vi",notifications:{email:!0,sms:!1,push:!0,lowStock:!0,newOrders:!0,returns:!0},dashboard:{defaultView:"overview",widgets:["sales","inventory","orders"]}},performance:"sales_staff"===e.role?{currentMonthSales:0,lastMonthSales:0,salesGrowth:0,averageOrderValue:0,totalOrdersProcessed:0,returnRate:0}:void 0,failedLoginAttempts:0,isDeleted:!1,createdAt:n.EK.now(),updatedAt:n.EK.now(),createdBy:(null===(r=i.I8.currentUser)||void 0===r?void 0:r.uid)||"system",updatedBy:(null===(s=i.I8.currentUser)||void 0===s?void 0:s.uid)||"system",mustChangePassword:e.mustChangePassword||!1,notes:e.notes,tags:e.tags},l=(0,n.JU)(i.db,"users",t.uid);await (0,n.pl)(l,a);let u=v(t,a);return c(u),p(a),u}catch(e){throw console.error("Registration failed:",e),Error(e.message||"Registration failed. Please try again.")}finally{w(!1)}},[v]),b=(0,a.useCallback)(async e=>{w(!0);try{await (0,o.LS)(i.I8,e)}catch(e){throw console.error("Password reset failed:",e),Error(e.message||"Failed to send password reset email.")}finally{w(!1)}},[]),k=(0,a.useCallback)(async e=>{if(!i.I8.currentUser)throw Error("No authenticated user found.");if(e.newPassword!==e.confirmPassword)throw Error("New passwords do not match.");w(!0);try{let r=o.w9.credential(i.I8.currentUser.email,e.currentPassword);if(await (0,o.aF)(i.I8.currentUser,r),await (0,o.gQ)(i.I8.currentUser,e.newPassword),d){let e=(0,n.JU)(i.db,"users",i.I8.currentUser.uid);await (0,n.r7)(e,{passwordLastChanged:n.EK.now(),mustChangePassword:!1,updatedAt:n.EK.now()})}}catch(e){throw console.error("Password change failed:",e),Error(e.message||"Failed to change password.")}finally{w(!1)}},[d]),A=(0,a.useCallback)(async()=>{if(i.I8.currentUser)try{let e=(0,n.JU)(i.db,"users",i.I8.currentUser.uid),r=await (0,n.QT)(e);if(r.exists()){let e=r.data(),s=v(i.I8.currentUser,e);c(s),p(e)}}catch(e){console.error("Failed to refresh user:",e)}},[v]),E=(0,a.useCallback)(async e=>{if(!i.I8.currentUser||!d)throw Error("No authenticated user found.");w(!0);try{let r=(0,n.JU)(i.db,"users",i.I8.currentUser.uid),s={...e,updatedAt:n.EK.now(),updatedBy:i.I8.currentUser.uid};await (0,n.r7)(r,s),await A()}catch(e){throw console.error("Failed to update user profile:",e),Error(e.message||"Failed to update profile.")}finally{w(!1)}},[d,A]),U=(0,a.useCallback)(e=>!!d&&(0,l.Fs)(d,e),[d]),_=(0,a.useCallback)((e,r,s)=>d?(0,l.av)(d,e,r,s):{hasPermission:!1,reason:"User not authenticated"},[d]),C=(0,a.useCallback)(e=>!!d&&(Array.isArray(e)?e.includes(d.role):d.role===e),[d]),S=(0,a.useCallback)(()=>s&&i.I8.currentUser?{user:s,accessToken:"",expiresAt:Date.now()+864e5}:null,[s]),L=(0,a.useCallback)(()=>!!s&&!!i.I8.currentUser,[s]),N=(0,a.useCallback)(()=>!!s&&s.isActive,[s]);return(0,a.useEffect)(()=>(0,o.Aj)(i.I8,async e=>{if(y(!0),e)try{let r=(0,n.JU)(i.db,"users",e.uid),s=await (0,n.QT)(r);if(s.exists()){let r=s.data();if(r.isActive&&!r.isDeleted){let s=v(e,r);c(s),p(r)}else await (0,o.w7)(i.I8),c(null),p(null)}else await (0,o.w7)(i.I8),c(null),p(null)}catch(e){console.error("Error fetching user document:",e),c(null),p(null)}else c(null),p(null);y(!1)}),[v]),(0,t.jsx)(u.Provider,{value:{user:s,userDocument:d,loading:m,initializing:f,login:g,logout:P,register:I,resetPassword:b,changePassword:k,refreshUser:A,updateUserProfile:E,hasPermission:U,canAccess:_,isRole:C,getSession:S,isAuthenticated:L,isActive:N},children:r})}function d(){let e=(0,a.useContext)(u);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},5091:function(e,r,s){s.d(r,{Bv:function(){return t},Fs:function(){return a},av:function(){return o},fi:function(){return n}});let t={admin:{name:"Administrator",level:100,permissions:["system.*","users.*","roles.*","permissions.*","stores.*","settings.*","audit.*","inventory.*","sales.*","customers.*","suppliers.*","reports.*","returns.*","warranty.*"]},store_manager:{name:"Store Manager",level:80,permissions:["users.read","users.update","users.create","inventory.read","inventory.create","inventory.update","inventory.delete","inventory.adjust","inventory.transfer","sales.read","sales.create","sales.update","sales.process_returns","sales.apply_discounts","sales.override_prices","customers.read","customers.create","customers.update","customers.delete","reports.read","reports.create","reports.export","analytics.read","suppliers.read","suppliers.create","suppliers.update","settings.read","settings.update"]},sales_staff:{name:"Sales Staff",level:50,permissions:["sales.read","sales.create","sales.update_own","sales.process_simple_returns","inventory.read","inventory.check_availability","inventory.reserve","customers.read","customers.create","customers.update","reports.read_own","reports.daily_summary","products.read","warranty.check","users.read_own","users.update_own"]},warehouse_staff:{name:"Warehouse Staff",level:40,permissions:["inventory.read","inventory.create","inventory.update","inventory.receive","inventory.move","inventory.count","inventory.adjust","products.read","products.create","products.update","suppliers.read","purchase_orders.read","purchase_orders.receive","sales.read","sales.process_returns","reports.inventory","reports.stock_movements","users.read_own","users.update_own"]},viewer:{name:"Viewer",level:10,permissions:["products.read","inventory.read","sales.read","customers.read","reports.read","users.read_own","warranty.check"]}};function a(e,r){var s,t;if("admin"===e.role||e.permissions.includes(r)||(null===(s=e.customPermissions)||void 0===s?void 0:s.includes(r)))return!0;let a=r.split(".");for(let r=a.length-1;r>=0;r--){let s=a.slice(0,r).join(".")+".*";if(e.permissions.includes(s)||(null===(t=e.customPermissions)||void 0===t?void 0:t.includes(s)))return!0}return!1}function o(e,r,s,t){let o="".concat(r,".").concat(s);return a(e,o)?o.endsWith("_own")&&t&&(t.userId||t.createdBy||t.staffId)!==e.id?{hasPermission:!1,reason:"Can only access own resources"}:{hasPermission:!0}:{hasPermission:!1,reason:"Insufficient permissions",requiredPermissions:[o]}}function n(e){var r;return Array.from(new Set([...(null===(r=t[e.role])||void 0===r?void 0:r.permissions)||[],...e.customPermissions||[]]))}}}]);