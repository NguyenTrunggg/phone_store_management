"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[831],{9174:function(e,t,r){r.d(t,{C:function(){return n}});var a=r(7437);r(2265);var o=r(535),s=r(3448);let i=(0,o.j)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function n(e){let{className:t,variant:r,...o}=e;return(0,a.jsx)("div",{className:(0,s.cn)(i({variant:r}),t),...o})}},2381:function(e,t,r){r.d(t,{d:function(){return c},z:function(){return l}});var a=r(7437),o=r(2265),s=r(7053),i=r(535),n=r(3448);let c=(0,i.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),l=o.forwardRef((e,t)=>{let{className:r,variant:o,size:i,asChild:l=!1,...d}=e,u=l?s.g7:"button";return(0,a.jsx)(u,{className:(0,n.cn)(c({variant:o,size:i,className:r})),ref:t,...d})});l.displayName="Button"},4291:function(e,t,r){r.d(t,{$N:function(){return g},Be:function(){return h},Vq:function(){return c},cN:function(){return p},cZ:function(){return f},fK:function(){return m},hg:function(){return l}});var a=r(7437),o=r(2265),s=r(9027),i=r(2489),n=r(3448);let c=s.fC,l=s.xz,d=s.h_;s.x8;let u=o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)(s.aV,{ref:t,className:(0,n.cn)("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",r),...o})});u.displayName=s.aV.displayName;let f=o.forwardRef((e,t)=>{let{className:r,children:o,...c}=e;return(0,a.jsxs)(d,{children:[(0,a.jsx)(u,{}),(0,a.jsxs)(s.VY,{ref:t,className:(0,n.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",r),...c,children:[o,(0,a.jsxs)(s.x8,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,a.jsx)(i.Z,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});f.displayName=s.VY.displayName;let m=e=>{let{className:t,...r}=e;return(0,a.jsx)("div",{className:(0,n.cn)("flex flex-col space-y-1.5 text-center sm:text-left",t),...r})};m.displayName="DialogHeader";let p=e=>{let{className:t,...r}=e;return(0,a.jsx)("div",{className:(0,n.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...r})};p.displayName="DialogFooter";let g=o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)(s.Dx,{ref:t,className:(0,n.cn)("text-lg font-semibold leading-none tracking-tight",r),...o})});g.displayName=s.Dx.displayName;let h=o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)(s.dk,{ref:t,className:(0,n.cn)("text-sm text-muted-foreground",r),...o})});h.displayName=s.dk.displayName},279:function(e,t,r){r.d(t,{I:function(){return i}});var a=r(7437),o=r(2265),s=r(3448);let i=o.forwardRef((e,t)=>{let{className:r,type:o,...i}=e;return(0,a.jsx)("input",{type:o,className:(0,s.cn)("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",r),ref:t,...i})});i.displayName="Input"},5060:function(e,t,r){r.d(t,{_:function(){return l}});var a=r(7437),o=r(2265),s=r(6394),i=r(535),n=r(3448);let c=(0,i.j)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),l=o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)(s.f,{ref:t,className:(0,n.cn)(c(),r),...o})});l.displayName=s.f.displayName},5291:function(e,t,r){r.d(t,{Bw:function(){return g},Ph:function(){return d},Ql:function(){return h},i4:function(){return f},ki:function(){return u}});var a=r(7437),o=r(2265),s=r(3911),i=r(875),n=r(2135),c=r(401),l=r(3448);let d=s.fC;s.ZA;let u=s.B4,f=o.forwardRef((e,t)=>{let{className:r,children:o,...n}=e;return(0,a.jsxs)(s.xz,{ref:t,className:(0,l.cn)("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",r),...n,children:[o,(0,a.jsx)(s.JO,{asChild:!0,children:(0,a.jsx)(i.Z,{className:"h-4 w-4 opacity-50"})})]})});f.displayName=s.xz.displayName;let m=o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)(s.u_,{ref:t,className:(0,l.cn)("flex cursor-default items-center justify-center py-1",r),...o,children:(0,a.jsx)(n.Z,{className:"h-4 w-4"})})});m.displayName=s.u_.displayName;let p=o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)(s.$G,{ref:t,className:(0,l.cn)("flex cursor-default items-center justify-center py-1",r),...o,children:(0,a.jsx)(i.Z,{className:"h-4 w-4"})})});p.displayName=s.$G.displayName;let g=o.forwardRef((e,t)=>{let{className:r,children:o,position:i="popper",...n}=e;return(0,a.jsx)(s.h_,{children:(0,a.jsxs)(s.VY,{ref:t,className:(0,l.cn)("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2","popper"===i&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",r),position:i,...n,children:[(0,a.jsx)(m,{}),(0,a.jsx)(s.l_,{className:(0,l.cn)("p-1","popper"===i&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:o}),(0,a.jsx)(p,{})]})})});g.displayName=s.VY.displayName,o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)(s.__,{ref:t,className:(0,l.cn)("py-1.5 pl-8 pr-2 text-sm font-semibold",r),...o})}).displayName=s.__.displayName;let h=o.forwardRef((e,t)=>{let{className:r,children:o,...i}=e;return(0,a.jsxs)(s.ck,{ref:t,className:(0,l.cn)("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",r),...i,children:[(0,a.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,a.jsx)(s.wU,{children:(0,a.jsx)(c.Z,{className:"h-4 w-4"})})}),(0,a.jsx)(s.eT,{children:o})]})});h.displayName=s.ck.displayName,o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)(s.Z0,{ref:t,className:(0,l.cn)("-mx-1 my-1 h-px bg-muted",r),...o})}).displayName=s.Z0.displayName},3675:function(e,t,r){r.d(t,{g:function(){return i}});var a=r(7437),o=r(2265),s=r(3448);let i=o.forwardRef((e,t)=>{let{className:r,...o}=e;return(0,a.jsx)("textarea",{className:(0,s.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",r),ref:t,...o})});i.displayName="Textarea"},87:function(e,t,r){r.d(t,{_:function(){return l}});var a=r(5978),o=r(6410),s=r(8086),i=r(3976);function n(e){return!!e&&"string"==typeof e&&/^[A-Za-z0-9][A-Za-z0-9_-]{1,18}[A-Za-z0-9]$/.test(e.trim())}class c extends s.bQ{async createProduct(e,t){try{var r,a,o,s,i;if(console.log("=== Product Creation Debug ==="),console.log("Input:",e),console.log("User ID:",t),!(null===(r=e.name)||void 0===r?void 0:r.trim()))return{success:!1,error:"T\xean sản phẩm kh\xf4ng được để trống",errorCode:"INVALID_PRODUCT_NAME"};console.log("Checking for duplicate product name:",e.name.trim());let n=await this.findProductByName(e.name.trim());if(n.success&&n.data)return console.error("Duplicate product name found:",e.name.trim()),{success:!1,error:"T\xean sản phẩm đ\xe3 tồn tại",errorCode:"DUPLICATE_PRODUCT_NAME"};let c=e.slug||e.name.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").trim();console.log("Generated slug:",c);let l={name:e.name.trim(),slug:c,totalVariants:0,activeVariants:0,totalStock:0,averagePrice:0,isActive:!0};e.description&&(l.description=e.description.trim()),l.brand=(null===(a=e.brand)||void 0===a?void 0:a.trim())||"Apple",l.category=(null===(o=e.category)||void 0===o?void 0:o.trim())||"Smartphones",l.tags=e.tags||[],l.attributes=e.attributes||{},l.images=[],(null===(s=e.baseImageUrl)||void 0===s?void 0:s.trim())&&(l.baseImageUrl=e.baseImageUrl.trim()),void 0!==e.displayOrder&&(l.displayOrder=e.displayOrder),(null===(i=e.internalNotes)||void 0===i?void 0:i.trim())&&(l.internalNotes=e.internalNotes.trim()),console.log("Final product data to be saved:",l);let d=await this.create(l,t);return console.log("Product creation result:",d),d}catch(e){return console.error("Error in createProduct:",e),this.handleError(e)}}async updateProduct(e,t,r){try{let o=await this.exists(e);if(!o.success||!o.data)return{success:!1,error:"Kh\xf4ng t\xecm thấy sản phẩm",errorCode:"PRODUCT_NOT_FOUND"};if(t.name){let r=await this.findProductByName(t.name.trim());if(r.success&&r.data&&r.data.id!==e)return{success:!1,error:"T\xean sản phẩm đ\xe3 tồn tại",errorCode:"DUPLICATE_PRODUCT_NAME"}}let s={...t,updatedAt:a.EK.now(),updatedBy:r};return t.name&&(s.name=t.name.trim()),await this.update(e,s,r)}catch(e){return this.handleError(e)}}async getProductWithVariants(e){try{let t=await this.getById(e);if(!t.success)return t;let r=await this.getVariantsByProductId(e);if(!r.success)return{success:!1,error:"Kh\xf4ng thể lấy th\xf4ng tin biến thể sản phẩm",errorCode:"VARIANTS_FETCH_FAILED"};let a=r.data||[],o=a.reduce((e,t)=>e+t.stockQuantity,0),s={...t.data,variants:a,totalStock:o};return{success:!0,data:s}}catch(e){return this.handleError(e)}}async getProductsWithVariantsForDropdown(){try{console.log("=== Getting products with variants for dropdown ===");let e=(0,a.IO)((0,a.hJ)(o.db,i.Ul.PRODUCTS),(0,a.ar)("isActive","==",!0)),t=await (0,a.PL)(e);console.log("Found products:",t.size),t.docs.forEach((e,t)=>{let r=e.data();console.log("Product ".concat(t+1,":"),{id:e.id,name:r.name,isActive:r.isActive,allFields:r})});let r=await Promise.all(t.docs.map(async e=>{let t=e.data();console.log("\n=== Processing product: ".concat(t.name," (").concat(e.id,") ==="));try{let r=(0,a.IO)((0,a.hJ)(o.db,"products",e.id,"variants"),(0,a.ar)("isActive","==",!0));console.log("Query path: products/".concat(e.id,"/variants"));let s=await (0,a.PL)(r);if(console.log("Found ".concat(s.size," variants for ").concat(t.name)),0===s.size){console.log("❌ No variants found for ".concat(t.name));let r=(0,a.hJ)(o.db,"products",e.id,"variants"),s=await (0,a.PL)(r);console.log("Total variants (ignoring isActive): ".concat(s.size)),s.docs.forEach((e,t)=>{let r=e.data();console.log("  Variant ".concat(t+1,":"),{id:e.id,isActive:r.isActive,sku:r.sku,colorName:r.colorName,storageCapacity:r.storageCapacity,allFields:r})})}else s.docs.forEach((e,t)=>{let r=e.data();console.log("  Active Variant ".concat(t+1,":"),{id:e.id,sku:r.sku,colorName:r.colorName,storageCapacity:r.storageCapacity,retailPrice:r.retailPrice,isActive:r.isActive})});let i=s.docs.map(e=>{let t=e.data();return console.log("Processing variant ".concat(e.id,":"),{storageCapacity:t.storageCapacity,colorName:t.colorName,sku:t.sku,retailPrice:t.retailPrice}),{id:e.id,storageCapacity:t.storageCapacity||"Unknown",colorName:t.colorName||"Unknown",sku:t.sku||"NO-SKU",price:t.retailPrice||0}});return console.log("Final variants for ".concat(t.name,":"),i),{id:e.id,name:t.name,variants:i}}catch(r){return console.error("❌ Error loading variants for ".concat(t.name,":"),r),{id:e.id,name:t.name,variants:[]}}}));console.log("\n=== All products before filtering ==="),r.forEach((e,t)=>{console.log("Product ".concat(t+1,": ").concat(e.name," - ").concat(e.variants.length," variants"))});let s=r.filter(e=>e.variants.length>0);return console.log("\n=== Products after filtering (with variants only) ==="),console.log("Filtered: ".concat(s.length,"/").concat(r.length," products")),s.forEach((e,t)=>{console.log("Product ".concat(t+1,": ").concat(e.name," - ").concat(e.variants.length," variants"))}),{success:!0,data:s}}catch(e){return console.error("❌ Error getting products with variants for dropdown:",e),this.handleError(e)}}async searchProducts(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{let t=[];void 0!==e.isActive&&t.push((0,a.ar)("isActive","==",e.isActive)),e.brand&&t.push((0,a.ar)("brand","==",e.brand)),e.category&&t.push((0,a.ar)("category","==",e.category)),e.tags&&e.tags.length>0&&t.push((0,a.ar)("tags","array-contains-any",e.tags));let r=e.sortBy||"name",o=e.sortOrder||"asc";t.push((0,a.Xo)(r,o));let s=(0,a.IO)(this.collectionRef,...t),i=(await (0,a.PL)(s)).docs.map(e=>({id:e.id,...e.data()}));if(e.searchTerm){let t=e.searchTerm.toLowerCase();i=i.filter(e=>{var r,a;return e.name.toLowerCase().includes(t)||(null===(r=e.description)||void 0===r?void 0:r.toLowerCase().includes(t))||(null===(a=e.tags)||void 0===a?void 0:a.some(e=>e.toLowerCase().includes(t)))})}return{success:!0,data:i}}catch(e){return this.handleError(e)}}async findProductByName(e){try{let t=(0,a.IO)(this.collectionRef,(0,a.ar)("name","==",e)),r=await (0,a.PL)(t);if(r.empty)return{success:!0,data:null};let o=r.docs[0];return{success:!0,data:{id:o.id,...o.data()}}}catch(e){return this.handleError(e)}}async createVariant(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"system";try{var s,c,l,d,u,f;let m;console.log("=== Variant Creation Debug ==="),console.log("Product ID:",e),console.log("Input:",t),console.log("User ID (fixed):",r);let p=t.sku||this.generateSKU(t.colorName,t.storageCapacity);if(console.log("Generated/Provided SKU:",p),!(null==p?void 0:p.trim()))return console.error("SKU validation failed - empty SKU:",p),{success:!1,error:"M\xe3 SKU kh\xf4ng được để trống",errorCode:"INVALID_SKU"};console.log("Validating SKU format:",p.trim());try{m=n(p.trim()),console.log("SKU validation result:",m)}catch(e){return console.error("SKU validation function error:",e),{success:!1,error:"Lỗi kiểm tra định dạng SKU",errorCode:"SKU_VALIDATION_ERROR"}}if(!m)return console.error("SKU format validation failed:",p),{success:!1,error:"M\xe3 SKU kh\xf4ng đ\xfang định dạng: ".concat(p),errorCode:"INVALID_SKU_FORMAT"};if(!(null===(s=t.colorName)||void 0===s?void 0:s.trim())||!(null===(c=t.storageCapacity)||void 0===c?void 0:c.trim()))return console.error("Color/Storage validation failed:",{colorName:t.colorName,storageCapacity:t.storageCapacity}),{success:!1,error:"M\xe0u sắc v\xe0 dung lượng kh\xf4ng được để trống",errorCode:"INVALID_VARIANT_INFO"};if(!t.retailPrice||t.retailPrice<=0)return console.error("Price validation failed:",t.retailPrice),{success:!1,error:"Gi\xe1 sản phẩm phải lớn hơn 0",errorCode:"INVALID_PRICE"};console.log("Checking if product exists:",e);let g=await this.exists(e);if(console.log("Product exists result:",g),!g.success||!g.data)return console.error("Product not found:",e),{success:!1,error:"Kh\xf4ng t\xecm thấy sản phẩm",errorCode:"PRODUCT_NOT_FOUND"};console.log("Checking for duplicate SKU:",p.trim());let h=await this.findVariantBySKU(p.trim());if(console.log("Existing variant check result:",h),h.success&&h.data)return console.error("Duplicate SKU found:",p),{success:!1,error:"M\xe3 SKU đ\xe3 tồn tại: ".concat(p),errorCode:"DUPLICATE_SKU"};console.log("Checking for duplicate variant in product:",e);let y=await this.findVariantByProductAndAttributes(e,t.colorName.trim(),t.storageCapacity.trim());if(console.log("Duplicate variant check result:",y),y.success&&y.data)return console.error("Duplicate variant found in product:",{productId:e,colorName:t.colorName,storageCapacity:t.storageCapacity}),{success:!1,error:"Biến thể sản phẩm đ\xe3 tồn tại",errorCode:"DUPLICATE_VARIANT"};let v={productId:e,sku:p.trim().toUpperCase(),colorName:t.colorName.trim(),storageCapacity:t.storageCapacity.trim(),retailPrice:t.retailPrice,status:"active",isActive:!0,isFeatured:!1,attributes:t.attributes||{},stockQuantity:0,reservedQuantity:0,soldQuantity:0,totalQuantity:0,lowStockThreshold:t.lowStockThreshold||5,reorderLevel:t.reorderLevel||10,lastStockUpdate:a.EK.now(),createdAt:a.EK.now(),updatedAt:a.EK.now(),createdBy:r,updatedBy:r};void 0!==t.costPrice&&t.costPrice>=0&&(v.costPrice=t.costPrice),(null===(l=t.colorHex)||void 0===l?void 0:l.trim())&&(v.colorHex=t.colorHex.trim()),void 0!==t.originalPrice&&t.originalPrice>0&&(v.originalPrice=t.originalPrice),(null===(d=t.imageUrl)||void 0===d?void 0:d.trim())&&(v.imageUrl=t.imageUrl.trim()),(null===(u=t.appleModelNumber)||void 0===u?void 0:u.trim())&&(v.appleModelNumber=t.appleModelNumber.trim()),(null===(f=t.applePartNumber)||void 0===f?void 0:f.trim())&&(v.applePartNumber=t.applePartNumber.trim()),t.launchDate&&(v.launchDate=a.EK.fromDate(t.launchDate)),void 0!==t.displayOrder&&(v.displayOrder=t.displayOrder),console.log("Final variant data to be saved:",v);let N=(0,a.hJ)(o.db,i.Ul.PRODUCTS,e,i.N9.VARIANTS);console.log("Adding variant to collection:",N.path);let b=await (0,a.ET)(N,v);console.log("Variant document created with ID:",b.id);let x=await (0,a.QT)(b);if(!x.exists())return console.error("Failed to retrieve created variant document"),{success:!1,error:"Kh\xf4ng thể tạo biến thể sản phẩm",errorCode:"VARIANT_CREATE_FAILED"};let w={id:x.id,...x.data()};return console.log("Variant created successfully:",w),{success:!0,data:w}}catch(e){return console.error("Error in createVariant:",e),this.handleError(e)}}async updateVariant(e,t,r,s){try{if(r.sku&&!n(r.sku.trim()))return{success:!1,error:"M\xe3 SKU kh\xf4ng đ\xfang định dạng",errorCode:"INVALID_SKU_FORMAT"};if(void 0!==r.retailPrice&&r.retailPrice<=0)return{success:!1,error:"Gi\xe1 sản phẩm phải lớn hơn 0",errorCode:"INVALID_PRICE"};if(r.sku){let e=await this.findVariantBySKU(r.sku.trim());if(e.success&&e.data&&e.data.id!==t)return{success:!1,error:"M\xe3 SKU đ\xe3 tồn tại",errorCode:"DUPLICATE_SKU"}}let c=(0,a.JU)(o.db,i.Ul.PRODUCTS,e,i.N9.VARIANTS,t),l={...r,updatedAt:a.EK.now(),updatedBy:s};r.sku&&(l.sku=r.sku.trim().toUpperCase()),await (0,a.r7)(c,l);let d=await (0,a.QT)(c);if(!d.exists())return{success:!1,error:"Kh\xf4ng thể cập nhật biến thể sản phẩm",errorCode:"VARIANT_UPDATE_FAILED"};return{success:!0,data:{id:d.id,...d.data()}}}catch(e){return this.handleError(e)}}async getVariantsByProductId(e){try{let t=(0,a.hJ)(o.db,i.Ul.PRODUCTS,e,i.N9.VARIANTS),r=(0,a.IO)(t,(0,a.Xo)("sku","asc")),s=(await (0,a.PL)(r)).docs.map(e=>({id:e.id,...e.data()}));return{success:!0,data:s}}catch(e){return this.handleError(e)}}async getVariantById(e,t){try{let r=(0,a.JU)(o.db,i.Ul.PRODUCTS,e,i.N9.VARIANTS,t),s=await (0,a.QT)(r);if(!s.exists())return{success:!1,error:"Kh\xf4ng t\xecm thấy biến thể sản phẩm",errorCode:"VARIANT_NOT_FOUND"};return{success:!0,data:{id:s.id,...s.data()}}}catch(e){return this.handleError(e)}}async searchVariants(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{let t=[];if(e.productId){let r=await this.getVariantsByProductId(e.productId);r.success&&(t=r.data||[])}else{let e=(0,a.hJ)(o.db,i.N9.VARIANTS),r=(0,a.IO)(e,(0,a.Xo)("sku","asc"));t=(await (0,a.PL)(r)).docs.map(e=>({id:e.id,...e.data()}))}if(e.searchTerm){let r=e.searchTerm.toLowerCase();t=t.filter(e=>e.sku.toLowerCase().includes(r)||e.colorName.toLowerCase().includes(r)||e.storageCapacity.toLowerCase().includes(r))}if(e.colorName&&(t=t.filter(t=>t.colorName===e.colorName)),e.storageCapacity&&(t=t.filter(t=>t.storageCapacity===e.storageCapacity)),e.status&&e.status.length>0&&(t=t.filter(t=>e.status.includes(t.status))),void 0!==e.isActive&&(t=t.filter(t=>t.isActive===e.isActive)),e.hasStock&&(t=t.filter(e=>e.stockQuantity>0)),void 0!==e.priceMin&&(t=t.filter(t=>void 0!==t.originalPrice&&t.originalPrice>=e.priceMin)),void 0!==e.priceMax&&(t=t.filter(t=>void 0!==t.originalPrice&&t.originalPrice<=e.priceMax)),e.sortBy){let r=e.sortBy,a=e.sortOrder||"asc";t.sort((e,t)=>{var o,s;let i=null!==(o=e[r])&&void 0!==o?o:"",n=null!==(s=t[r])&&void 0!==s?s:"";return"asc"===a?i>n?1:-1:i<n?1:-1})}return{success:!0,data:t}}catch(e){return this.handleError(e)}}async findVariantBySKU(e){try{let t=(0,a.hJ)(o.db,i.N9.VARIANTS),r=(0,a.IO)(t,(0,a.ar)("sku","==",e.toUpperCase())),s=await (0,a.PL)(r);if(s.empty)return{success:!0,data:null};let n=s.docs[0];return{success:!0,data:{id:n.id,...n.data()}}}catch(e){return this.handleError(e)}}async findVariantByProductAndAttributes(e,t,r){try{let s=(0,a.hJ)(o.db,i.Ul.PRODUCTS,e,i.N9.VARIANTS),n=(0,a.IO)(s,(0,a.ar)("colorName","==",t),(0,a.ar)("storageCapacity","==",r)),c=await (0,a.PL)(n);if(c.empty)return{success:!0,data:null};let l=c.docs[0];return{success:!0,data:{id:l.id,...l.data()}}}catch(e){return this.handleError(e)}}async deleteVariant(e,t,r){try{let s=(0,a.JU)(o.db,i.Ul.PRODUCTS,e,i.N9.VARIANTS,t);return await (0,a.r7)(s,{isActive:!1,updatedAt:a.EK.now(),updatedBy:r}),{success:!0}}catch(e){return this.handleError(e)}}generateSKU(e,t){let r=e.split(" ").map(e=>e.charAt(0)).join("").toUpperCase().substring(0,3),a=t.replace(/[^0-9]/g,""),o=Date.now().toString().slice(-4);return"IP-".concat(a,"-").concat(r,"-").concat(o)}async getAvailableColors(){try{let e=(0,a.hJ)(o.db,i.N9.VARIANTS),t=(0,a.IO)(e,(0,a.ar)("isActive","==",!0)),r=await (0,a.PL)(t),s=new Set;return r.docs.forEach(e=>{let t=e.data();s.add(t.colorName)}),{success:!0,data:Array.from(s).sort()}}catch(e){return this.handleError(e)}}async getAvailableStorageCapacities(){try{let e=(0,a.hJ)(o.db,i.N9.VARIANTS),t=(0,a.IO)(e,(0,a.ar)("isActive","==",!0)),r=await (0,a.PL)(t),s=new Set;return r.docs.forEach(e=>{let t=e.data();s.add(t.storageCapacity)}),{success:!0,data:Array.from(s).sort()}}catch(e){return this.handleError(e)}}async updateVariantStock(e,t,r,s){try{let n=(0,a.JU)(o.db,i.Ul.PRODUCTS,e,i.N9.VARIANTS,t),c={stockQuantity:r,lastStockUpdate:a.EK.now(),updatedAt:a.EK.now()};return void 0!==s&&(c.reservedQuantity=s),await (0,a.r7)(n,c),{success:!0}}catch(e){return this.handleError(e)}}constructor(){super(i.Ul.PRODUCTS)}}let l=new c}}]);